<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Korean OCR</title>
    <script type="application/javascript">
        function sendFile(file) {
            const uri = "/upload";
            const xhr = new XMLHttpRequest();

            let filename = file.name;
            console.log('filename: ' + filename);
            // let ext = filename.substring(filename.lastIndexOf('.') + 1).toLowerCase();
            // console.log('ext: ' + ext);

            let contentType = file.type;
            console.log('contentType: ' + contentType);

            xhr.open("POST", uri, true);
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    response = JSON.parse(xhr.responseText);
                    console.log("response: " + JSON.stringify(response));
                                        
                    // upload the file
                    const body = JSON.parse(response.body);
                    console.log('body: ', body);

                    const uploadURL = body.UploadURL;                    
                    console.log("UploadURL: ", uploadURL);

                    let xmlHttp = new XMLHttpRequest();
                    xmlHttp.open("PUT", uploadURL, true);       

                    const blob = new Blob([file], {type: contentType});
                    
                    xmlHttp.onreadystatechange = function() {
                        if (xmlHttp.readyState == XMLHttpRequest.DONE && xmlHttp.status == 200 ) {
                            console.log(xmlHttp.responseText);

                            alert(xmlHttp.responseText); // handle response.
                        }
                        else if(xmlHttp.readyState == XMLHttpRequest.DONE && xmlHttp.status != 200) {
                            console.log('status' + xmlHttp.status);
                            alert("Try again! The request was failed.");
                        }
                    };
        
                    xmlHttp.send(blob); 
                    console.log(xmlHttp.responseText);
                }
            };

            let requestObj = {
                "filename": filename,
                "contentType": contentType,
            }
            console.log("request: " + JSON.stringify(requestObj));
        
            let blob = new Blob([JSON.stringify(requestObj)], {type: 'application/json'});
        
            xhr.send(blob); 
        }

        function extractSentences(filename) {
            const uri = "/ocr";
            const xhr = new XMLHttpRequest();

            xhr.open("POST", uri, true);
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    response = JSON.parse(xhr.responseText);
                    console.log("response: " + JSON.stringify(response));
                                        
                    alert(xhr.responseText); // handle response.
                }
            };

            let requestObj = {
                "filename": filename
            }
            console.log("request: " + JSON.stringify(requestObj));
        
            let blob = new Blob([JSON.stringify(requestObj)], {type: 'application/json'});
        
            xhr.send(blob); 
        }


        window.onload = () => {
            let form = document.forms.myform;
            form.elements.sendButton.onclick = function(){
                let file = form.elements.filename.files[0];

                if(file){
                    sendFile(file);

                    previewImg.src = URL.createObjectURL(file)
                }else{
                    alert("Not file.");
                }
            };
            form.elements.extractButton.onclick = function(){
                let file = form.elements.filename.files[0];
                if(file){
                    extractSentences(file.name);
                }else{
                    alert("No file.");
                }
            };
        }
    </script>
</head>
<body>
    <h1>Korean OCR</h1>
    <h4>Upload the picture to read sentances</h4>
    <div>
        <form id="myform">
            <input type="file" accept=".gif, .jpg, .png" name="filename">
            <input type="button" name="sendButton" value="Upload">
            <input type="button" name="extractButton" value="Extract">
        </form>
    </div>
    <img id="previewImg" width="600" alt="Preview" />
</body>
</html>
